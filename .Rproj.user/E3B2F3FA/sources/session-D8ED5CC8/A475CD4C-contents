---
title: "R Notebook"
output: html_notebook
auther: Luhan Wen
---

# Question 1
```{r}
library(knitr)
knitr::include_graphics("https://imgur.com/a/UJlDjmT")
```

```{r}
library(RSQLite)

fpath = "~"
dbfile = "db.sqlite"
dbcon <- dbConnect(RSQLite::SQLite(), "db.db")
```

```{sql connection=dbcon}
drop table if exists book 
```

```{sql connection=dbcon}
drop table if exists author 
```

```{sql connection=dbcon}
drop table if exists genre 
```

# Question2 

```{sql connection=dbcon}
CREATE TABLE book (
    id VARCHAR(255) PRIMARY KEY,
    authorid INTEGER,
    title VARCHAR(255),
    edition INTEGER,
    gid INTEGER,
    price VARCHAR(255),
    publish_date DATE,
    description TEXT
    );
```

```{sql connection=dbcon}
CREATE TABLE author (
    authorid INTEGER PRIMARY KEY,
    name VARCHAR(255)
    );
```

```{sql connection=dbcon}
CREATE TABLE genre (
    gid INTEGER PRIMARY KEY,
    genre VARCHAR(255)
    );
```

# Question 3
```{r}
library(XML)

xmlObj <- xmlParse("Books-v3.xml")
catalog <- xmlRoot(xmlObj)

numBook <- xmlSize(catalog)

df.book <- data.frame (id = vector (mode = "character", 
                                     length = numBook),
                     authorid = vector (mode = "integer", 
                                         length = numBook),
                     title = vector (mode = "character", 
                                       length = numBook),
                     edition = vector (mode = "integer", 
                                        length = numBook),
                     gid = vector (mode = "integer", 
                                        length = numBook),
                     price = vector (mode = "character", 
                                        length = numBook),
                     publish_date = vector (mode = "character", 
                                        length = numBook),
                     description = vector (mode = "character", 
                                        length = numBook),
                     stringsAsFactors = F)

df.author <- data.frame (authorid = integer(),
                         name = character(),
                         stringsAsFactors = F
                         )

df.genre <- data.frame (gid = integer(),
                        genre = character(),
                        stringsAsFactors = F
                        )

# Support function to parse Author
parseAuthor <- function (anAuthorNode)
{
  name <- xmlValue(anAuthorNode[[1]])
  newAuthor.df <- data.frame(name, stringsAsFactors = F)
  
  return(newAuthor.df)
}

# Support function to parse Genre
parseGenre <- function (aGenreNode)
{
  genre <- xmlValue(aGenreNode[[1]])
  newGenre.df <- data.frame(genre, stringsAsFactors = F)
  
  return(newGenre.df)
}

# check if that element is already in the data frame
rowExists <- function (aRow, aDF)
{
  n <- nrow(aDF)
  if (n == 0)
  {
    # data frame is empty, so can't exist
    return(0)
  }
  
  for (a in 1:n)
  {
    # check if all columns match for a row; ignore the aID column
    if (all(aDF[a,] == aRow[1,]))
    {
      # found a match; return it's ID
      return(a)
    }
  }
  
  # none matched
  return(0)
}

for (i in 1:numBook) {
  aRow <- catalog[[i]]
  a <- xmlAttrs(aRow)
  id <- as.character(a[1])
  
  title <- xmlValue(aRow[[2]])
  if (xmlName(aRow[[3]]) == "edition"){
    edition <- xmlValue(aRow[[3]])
    genreIterm <- aRow[[4]]
    price <- xmlValue(aRow[[5]])
    publish_date <- xmlValue(aRow[[6]])
    description <- xmlValue(aRow[[7]])
  }else{
    edition <- 1
    genreIterm <- aRow[[3]]
    price <- xmlValue(aRow[[4]])
    publish_date <- xmlValue(aRow[[5]])
    description <- xmlValue(aRow[[6]])
  }
  
  
  df.book[i,'id'] <- as.character(id)
  df.book[i,'title'] <- as.character(title)
  df.book[i,'edition'] <- as.character(edition)
  df.book[i,'price'] <- as.character(price)
  df.book[i,'publish_date'] <- as.character(publish_date)
  df.book[i,'description'] <- as.character(description)
  
  # parse the author
  author <- parseAuthor(aRow[[1]])
  pk.Author <- rowExists(author, df.author[2])
  if (pk.Author == 0)
  {
    # does not exist, so add
    pk.Author <- nrow(df.author) + 1
    df.author[pk.Author,2:ncol(df.author)] <- author[1]
    df.author[pk.Author,1] <- pk.Author
  }
  df.book$authorid[i] <- pk.Author
  
  # parse the genre
  genre <- parseGenre(genreIterm)
  pk.genre <- rowExists(genre, df.genre[2])
  if (pk.genre == 0)
  {
    # does not exist, so add
    pk.genre <- nrow(df.genre) + 1
    df.genre[pk.genre,2:ncol(df.genre)] <- genre[1]
    df.genre[pk.genre,1] <- pk.genre
  }
  df.book$gid[i] <- pk.genre
}

head(df.author,10)
```

# Question 4
```{r}
dbWriteTable(dbcon, "book", df.book, overwrite = T)
dbWriteTable(dbcon, "author", df.author, overwrite = T)
dbWriteTable(dbcon, "genre", df.genre, overwrite = T)
```

```{sql connection=dbcon}
select b.*, a.name, g.genre from book b
left join author a
on a.authorid = b.authorid
left join genre g
on g.gid = b.gid
```


# Question 5.a: What is the number of genres have at least three books?
```{sql connection=dbcon}
select g.genre, a.cnt from
(select gid, count(*) as cnt 
from book 
group by gid
having cnt >= 3) a
left join genre g
on g.gid = a.gid
```

# Question 5.b: What is the oldest year in which a publication was published?
```{sql connection=dbcon}
select min(strftime('%Y',publish_date)) as "Year"
from book
```

# Question 5.c: Find the number of books and average price for each genre.
```{sql connection=dbcon}
select genre, numofbook, avgPrice
from genre g
inner join(
select gid, count(*) as numofbook, AVG(price) as avgPrice
from book
group by gid) a
on a.gid == g.gid
```

# Question 5.d: List the title and author of all books that are less than 0.8*AVG or more than 1.2*AVG, where AVG is the average price of all books. As a predicate logic expression: { b : books(b) & (b.price < 0.8*AVG(books.price) | b.price > 1.2*AVG(books.price)) }

```{sql connection=dbcon}
select b.title, a.name as author, price
from book b
left join author a
on b.authorid = a.authorid
where price <= 0.8 * (select avg(price) from book) or price >= 1.2 * (select avg(price) from book)
```

```{r}
dbDisconnect(dbcon)
```

