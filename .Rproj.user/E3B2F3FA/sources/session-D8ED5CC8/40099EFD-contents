---
title: "R Notebook"
output: html_notebook
---

```{r}
library(XML)
library(RSQLite)
library(DBI)
library(knitr)
library(dplyr)
library(dbplyr)
library(sqldf)
library(ggplot2)
library(lubridate)
library(stringr)

dbfile <- "pubmedDB.db"
dbcon <- dbConnect(RSQLite::SQLite(), dbfile)
```

```{sql connection=dbcon}
SELECT * FROM Articles;

```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable")
sqlcmd <- "SELECT Authors.AID, Authors.lastName, Authors.foreName, AuthorLists.articleID 
           FROM Authors
           JOIN AuthorLists ON Authors.AID = AuthorLists.authorID"
x <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "tempTable", x)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable2")
sqlcmd <- "SELECT AID, lastName, foreName, COUNT(AID) AS Number_of_Articles
            FROM tempTable
            GROUP BY AID"
y <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "tempTable2", y)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable3")
sqlcmd <- "SELECT articleID, COUNT(*) AS Number_of_coworkers
            FROM AuthorLists
            GROUP BY articleID"
z <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "tempTable3", z)
```
```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Author_Fact")
sqlcmd <- "SELECT tempTable.AID, tempTable.lastName, tempTable.foreName, tempTable2.Number_of_Articles,         tempTable3.Number_of_coworkers, Articles.PMID AS articleID, Articles.articleTitle
            FROM tempTable
            JOIN tempTable2 ON tempTable.AID = tempTable2.AID
            JOIN tempTable3 ON tempTable.articleID = tempTable3.articleID
            JOIN Articles on tempTable.articleID = Articles.PMID"
k <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Author_Fact", k)
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable")
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable2")
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable3")
```

```{sql connection=dbcon}
SELECT * FROM Author_Fact;
```


```{sql connection=dbcon}
SELECT * FROM Journals

```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS tempTable")

sqlcmd <- "SELECT ISSN, journalTitle, pubDate
FROM Journals"

temp <- dbGetQuery(dbcon, sqlcmd)

temp$pub_year <- with(temp, substr(temp[[3]], 1, 4))
temp$pub_month <- with(temp, ifelse(str_count(temp[[3]], ' ') == 0, 
                                    substr(temp[[3]], 5, 7), substr(temp[[3]], 6, 8))
                                      )
temp <- temp %>% mutate(
pub_quarter = case_when(
    pub_month == 'Jan' ~ '1',
    pub_month == 'Feb' ~ '1',
    pub_month == 'Mar'~ '1',
    pub_month == 'Apr' ~ '2',
    pub_month == 'May' ~ '2',
    pub_month == 'Jun' ~ '2',
    pub_month == 'Jul' ~ '3',
    pub_month == 'Aug' ~ '3',
    pub_month == 'Sep' ~ '3',
    pub_month == 'Oct' ~ '4',
    pub_month == 'Nov' ~ '4',
    pub_month == 'Dec' ~ '4',
)
)

dbWriteTable(dbcon, "tempTable", temp)
```
```{sql connection=dbcon}
SELECT * FROM tempTable;

```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Jan")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Jan
            FROM tempTable
            WHERE pub_month == '","Jan","'
            GROUP BY ISSN")
Journal_Jan <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Jan", Journal_Jan)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Feb")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Feb
            FROM tempTable
            WHERE pub_month == '","Feb","'
            GROUP BY ISSN")
Journal_Feb <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Feb", Journal_Feb)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Mar")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Mar
            FROM tempTable
            WHERE pub_month == '","Mar","'
            GROUP BY ISSN")
Journal_Mar <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Mar", Journal_Mar)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Apr")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Apr
            FROM tempTable
            WHERE pub_month == '","Apr","'
            GROUP BY ISSN")
Journal_Apr <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Apr", Journal_Apr)
```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_May")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_May
            FROM tempTable
            WHERE pub_month == '","May","'
            GROUP BY ISSN")
Journal_May <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_May", Journal_May)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Jun")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Jun
            FROM tempTable
            WHERE pub_month == '","Jun","'
            GROUP BY ISSN")
Journal_Jun <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Jun", Journal_Jun)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Jul")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Jul
            FROM tempTable
            WHERE pub_month == '","Jul","'
            GROUP BY ISSN")
Journal_Jul <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Jul", Journal_Jul)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Aug")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Aug
            FROM tempTable
            WHERE pub_month == '","Aug","'
            GROUP BY ISSN")
Journal_Aug <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Aug", Journal_Aug)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Sep")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Sep
            FROM tempTable
            WHERE pub_month == '","Sep","'
            GROUP BY ISSN")
Journal_Sep <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Sep", Journal_Sep)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Oct")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Oct
            FROM tempTable
            WHERE pub_month == '","Oct","'
            GROUP BY ISSN")
Journal_Oct <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Oct", Journal_Oct)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Nov")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Nov
            FROM tempTable
            WHERE pub_month == '","Nov","'
            GROUP BY ISSN")
Journal_Nov <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Nov", Journal_Nov)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Dec")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Dec
            FROM tempTable
            WHERE pub_month == '","Dec","'
            GROUP BY ISSN")
Journal_Dec <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Dec", Journal_Dec)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Quarter1")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Quarter1
            FROM tempTable
            WHERE pub_quarter == 1
            GROUP BY ISSN")
Journal_Quarter1 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Quarter1", Journal_Quarter1)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Quarter2")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Quarter2
            FROM tempTable
            WHERE pub_quarter == 2
            GROUP BY ISSN")
Journal_Quarter2 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Quarter2", Journal_Quarter2)
```
```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Quarter3")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Quarter3
            FROM tempTable
            WHERE pub_quarter == 3
            GROUP BY ISSN")
Journal_Quarter3 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Quarter3", Journal_Quarter3)
```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Quarter4")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_Quarter4
            FROM tempTable
            WHERE pub_quarter == 4
            GROUP BY ISSN")
Journal_Quarter4 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Quarter4", Journal_Quarter4)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_1975")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_1975
            FROM tempTable
            WHERE pub_year == 1975
            GROUP BY ISSN")
Journal_1975 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_1975", Journal_1975)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_1976")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_1976
            FROM tempTable
            WHERE pub_year == 1976
            GROUP BY ISSN")
Journal_1976 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_1976", Journal_1976)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_1977")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_1977
            FROM tempTable
            WHERE pub_year == 1977
            GROUP BY ISSN")
Journal_1977 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_1977", Journal_1977)
```

```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_1978")
sqlcmd <- paste0("SELECT ISSN, COUNT(ISSN) AS Number_of_Articles_1978
            FROM tempTable
            WHERE pub_year == 1978
            GROUP BY ISSN")
Journal_1978 <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_1978", Journal_1978)
```

```{sql connection=dbcon}
SELECT * FROM tempTable
```


```{sql connection=dbcon}
SELECT Journals.ISSN, Journals.journalTitle, Journal_1975.Number_of_Articles_1975, Journal_1976.Number_of_Articles_1976,
Journal_1977.Number_of_Articles_1977, Journal_Quarter1.Number_of_Articles_Quarter1,
Journal_Quarter2.Number_of_Articles_Quarter2, Journal_Quarter3.Number_of_Articles_Quarter3, Journal_Quarter4.Number_of_Articles_Quarter4, Journal_Jan.Number_of_Articles_Jan, Journal_Feb.Number_of_Articles_Feb,
Journal_Mar.Number_of_Articles_Mar, Journal_Apr.Number_of_Articles_Apr, Journal_May.Number_of_Articles_May,
Journal_Jun.Number_of_Articles_Jun, Journal_Jul.Number_of_Articles_Jul, Journal_Aug.Number_of_Articles_Aug,
Journal_Sep.Number_of_Articles_Sep, Journal_Oct.Number_of_Articles_Oct, Journal_Nov.Number_of_Articles_Nov,
Journal_Dec.Number_of_Articles_Dec
FROM Journals
LEFT JOIN Journal_1975 ON Journals.ISSN = Journal_1975.ISSN
LEFT JOIN Journal_1976 ON Journals.ISSN = Journal_1976.ISSN
LEFT JOIN Journal_1977 ON Journals.ISSN = Journal_1977.ISSN
LEFT JOIN Journal_1978 ON Journals.ISSN = Journal_1978.ISSN
LEFT JOIN Journal_Quarter1 ON Journals.ISSN = Journal_Quarter1.ISSN
LEFT JOIN Journal_Quarter2 ON Journals.ISSN = Journal_Quarter2.ISSN
LEFT JOIN Journal_Quarter3 ON Journals.ISSN = Journal_Quarter3.ISSN
LEFT JOIN Journal_Quarter4 ON Journals.ISSN = Journal_Quarter4.ISSN
LEFT JOIN Journal_Jan ON Journals.ISSN = Journal_Jan.ISSN
LEFT JOIN Journal_Feb ON Journals.ISSN = Journal_Feb.ISSN
LEFT JOIN Journal_Mar ON Journals.ISSN = Journal_Mar.ISSN
LEFT JOIN Journal_Apr ON Journals.ISSN = Journal_Apr.ISSN
LEFT JOIN Journal_May ON Journals.ISSN = Journal_May.ISSN
LEFT JOIN Journal_Jun ON Journals.ISSN = Journal_Jun.ISSN
LEFT JOIN Journal_Jul ON Journals.ISSN = Journal_Jul.ISSN
LEFT JOIN Journal_Aug ON Journals.ISSN = Journal_Aug.ISSN
LEFT JOIN Journal_Sep ON Journals.ISSN = Journal_Sep.ISSN
LEFT JOIN Journal_Oct ON Journals.ISSN = Journal_Oct.ISSN
LEFT JOIN Journal_Nov ON Journals.ISSN = Journal_Nov.ISSN
LEFT JOIN Journal_Dec ON Journals.ISSN = Journal_Dec.ISSN

```


```{r}
dbExecute(dbcon, "DROP TABLE IF EXISTS Journal_Fact")
sqlcmd <- "SELECT Journals.ISSN, Journals.journalTitle, Journal_1975.Number_of_Articles_1975,
Journal_1976.Number_of_Articles_1976, Journal_1977.Number_of_Articles_1977, Journal_Quarter1.Number_of_Articles_Quarter1,
Journal_Quarter2.Number_of_Articles_Quarter2, Journal_Quarter3.Number_of_Articles_Quarter3, Journal_Quarter4.Number_of_Articles_Quarter4, Journal_Jan.Number_of_Articles_Jan, Journal_Feb.Number_of_Articles_Feb,
Journal_Mar.Number_of_Articles_Mar, Journal_Apr.Number_of_Articles_Apr, Journal_May.Number_of_Articles_May,
Journal_Jun.Number_of_Articles_Jun, Journal_Jul.Number_of_Articles_Jul, Journal_Aug.Number_of_Articles_Aug,
Journal_Sep.Number_of_Articles_Sep, Journal_Oct.Number_of_Articles_Oct, Journal_Nov.Number_of_Articles_Nov,
Journal_Dec.Number_of_Articles_Dec
FROM Journals
LEFT JOIN Journal_1975 ON Journals.ISSN = Journal_1975.ISSN
LEFT JOIN Journal_1976 ON Journals.ISSN = Journal_1976.ISSN
LEFT JOIN Journal_1977 ON Journals.ISSN = Journal_1977.ISSN
LEFT JOIN Journal_1978 ON Journals.ISSN = Journal_1978.ISSN
LEFT JOIN Journal_Quarter1 ON Journals.ISSN = Journal_Quarter1.ISSN
LEFT JOIN Journal_Quarter2 ON Journals.ISSN = Journal_Quarter2.ISSN
LEFT JOIN Journal_Quarter3 ON Journals.ISSN = Journal_Quarter3.ISSN
LEFT JOIN Journal_Quarter4 ON Journals.ISSN = Journal_Quarter4.ISSN
LEFT JOIN Journal_Jan ON Journals.ISSN = Journal_Jan.ISSN
LEFT JOIN Journal_Feb ON Journals.ISSN = Journal_Feb.ISSN
LEFT JOIN Journal_Mar ON Journals.ISSN = Journal_Mar.ISSN
LEFT JOIN Journal_Apr ON Journals.ISSN = Journal_Apr.ISSN
LEFT JOIN Journal_May ON Journals.ISSN = Journal_May.ISSN
LEFT JOIN Journal_Jun ON Journals.ISSN = Journal_Jun.ISSN
LEFT JOIN Journal_Jul ON Journals.ISSN = Journal_Jul.ISSN
LEFT JOIN Journal_Aug ON Journals.ISSN = Journal_Aug.ISSN
LEFT JOIN Journal_Sep ON Journals.ISSN = Journal_Sep.ISSN
LEFT JOIN Journal_Oct ON Journals.ISSN = Journal_Oct.ISSN
LEFT JOIN Journal_Nov ON Journals.ISSN = Journal_Nov.ISSN
LEFT JOIN Journal_Dec ON Journals.ISSN = Journal_Dec.ISSN"

x <- dbGetQuery(dbcon, sqlcmd)
dbWriteTable(dbcon, "Journal_Fact", x)
```
```{sql connection=dbcon}
SELECT * FROM Journal_Fact

```



```{r}
dbDisconnect(dbcon)
```
